@if (dataSource) {
  <cdk-tree
    #tree
    class="ngcx-tree"
    [dataSource]="dataSource"
    [treeControl]="treeControl"
    cdkDropListGroup
    [class.dragging]="dragging"
    (keyup.arrowup)="keyDownArrowUp($event)"
    (keydown.arrowdown)="keyDownArrowDown($event)"
    (keydown.arrowleft)="keyDownArrowLeft($event)"
    (keydown.arrowright)="keyDownArrowRight($event)"
    tabindex="0">
    <cdk-nested-tree-node *cdkTreeNodeDef="let node" class="tree-node">
      @if (allowDrop(node, DropType.DROP_AFTER); as dropControl) {
        <div
          cdkDropList
          [id]="node.id + '_' + DropType.DROP_AFTER"
          class="tree-node-container-drop-zone after-expanded-node"
          [class.hide]="dropControl.hideDrop || !treeControl.isExpanded(node)"
          [class.no-drop]="dropControl.preventDrop">
          <div class="drop-insert-line"></div>
          @if (dropControl.preventDropReason) {
            <div class="tooltip">
              {{ dropControl.preventDropReason }}
            </div>
          }
        </div>
      }
      <div class="tree-node-container">
        @if (allowDrop(node, DropType.DROP_BEFORE); as dropControl) {
          <div
            cdkDropList
            [id]="node.id + '_' + DropType.DROP_BEFORE"
            class="tree-node-container-drop-zone before-node"
            [class.hide]="!node.isFirstChild || dropControl.hideDrop"
            [class.no-drop]="dropControl.preventDrop">
            <div class="drop-insert-line"></div>
            @if (dropControl.preventDropReason) {
              <div class="tooltip">
                {{ dropControl.preventDropReason }}
              </div>
            }
          </div>
        }
        @if (allowDrop(node, DropType.DROP_INTO); as dropControl) {
          <div
            cdkDropList
            [id]="node.id + '_' + DropType.DROP_INTO"
            class="tree-node-container-drop-zone into-node"
            [class.hide]="dropControl.hideDrop"
            [class.no-drop]="dropControl.preventDrop">
            @if (dropControl.preventDropReason) {
              <div class="tooltip">
                {{ dropControl.preventDropReason }}
              </div>
            }
          </div>
        }
        @if (allowDrop(node, DropType.DROP_AFTER); as dropControl) {
          <div
            cdkDropList
            [id]="node.id + '_' + DropType.DROP_AFTER"
            class="tree-node-container-drop-zone after-node"
            [class.last]="node.isLastChild"
            [class.hide]="treeControl.isExpanded(node) || dropControl.hideDrop"
            [class.no-drop]="dropControl.preventDrop">
            <div class="drop-insert-line"></div>
            @if (dropControl.preventDropReason) {
              <div class="tooltip">
                {{ dropControl.preventDropReason }}
              </div>
            }
          </div>
        }
        <div
          cdkDropList
          [cdkDropListData]="node"
          [cdkDropListEnterPredicate]="disable"
          [cdkDropListSortPredicate]="disable">
          <div
            cdkDrag
            [cdkDragDisabled]="disableDrag(node)"
            [cdkDragData]="node"
            (cdkDragStarted)="dragging = node"
            (cdkDragReleased)="handleDragRelease($event)">
            <div *cdkDragPlaceholder></div>
            <div
              class="tree-node-content-container"
              [class.first]="node.isFirstChild"
              [class.last]="node.isLastChild"
              [class.expanded]="treeControl.isExpanded(node)">
              <ngcx-tree-node
                style="width: 100%"
                [nodeWrapper]="node"
                [isSelected]="node.id === selectedNode?.id"
                [treeControl]="treeControl"
                [treeConfig]="config"
                (customEvent)="customEvent.emit($event)"
              (clickEvent)="nodeClicked(node)"></ngcx-tree-node>
            </div>
          </div>
          @if (node.id === dragging?.id) {
            <ngcx-tree-node
              [nodeWrapper]="node"
              [treeControl]="treeControl"
            [treeConfig]="config"></ngcx-tree-node>
          }
        </div>
      </div>
      @if (treeControl.isExpanded(node)) {
        <div
          class="tree-node-children-container"
          [class.first]="node.isFirstChild"
          [class.last]="node.isLastChild">
          <div cdkTreeNodeOutlet></div>
        </div>
      }
    </cdk-nested-tree-node>
  </cdk-tree>
}
